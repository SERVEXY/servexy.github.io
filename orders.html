<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Orders</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
* { box-sizing:border-box; font-family:Inter,system-ui }
body { margin:0; background:#f7f9fc; color:#111 }

/* NAV */
.nav {
  display:flex; gap:12px; padding:16px;
  justify-content:center; background:white;
  box-shadow:0 4px 20px rgba(0,0,0,.05);
}
.nav-btn {
  padding:10px 18px; border-radius:12px;
  background:#f1f4ff; cursor:pointer;
}
a { text-decoration:none; color:inherit }
.nav-btn:hover { background:#4f6cff; color:white }

/* PAGE */
.container { padding:20px; max-width:1200px; margin:auto }
h1 { margin-bottom:12px }

/* STATS */
.stats {
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
  gap:16px; margin:20px 0;
}
.stat-card {
  background:white; padding:18px;
  border-radius:18px;
  box-shadow:0 12px 40px rgba(0,0,0,.06);
}
.stat-card h3 { margin:0; font-size:14px; opacity:.6 }
.stat-card p { font-size:28px; margin:6px 0 0 }

/* GRAPH */
.graphs {
  background:white;
  padding:16px;
  border-radius:18px;
  box-shadow:0 12px 40px rgba(0,0,0,.06);
}
.graphs canvas {
  width:100% !important;
  height:260px !important;
}

/* FILTER CARDS */
.control-card {
  background:white;
  padding:14px;
  border-radius:18px;
  box-shadow:0 8px 30px rgba(0,0,0,.05);
  margin-top:16px;
  display:flex;
  gap:10px;
  flex-wrap:wrap;
}
.control-card button {
  padding:10px 14px;
  border:none;
  border-radius:12px;
  background:#f1f4ff;
  cursor:pointer;
}
.control-card button.active {
  background:#4f6cff;
  color:white;
}

/* ORDERS */
.grid {
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(260px,1fr));
  gap:16px; margin-top:24px;
}
.card {
  background:white; padding:16px;
  border-radius:18px;
  box-shadow:0 12px 40px rgba(0,0,0,.06);
}
.actions { display:flex; gap:8px; margin-top:10px }
.actions button {
  flex:1; border:none; padding:8px;
  border-radius:10px; cursor:pointer;
}
.deliver { background:#e6fffa }

/* LOADER */
.loader {
  position:fixed; inset:0;
  background:rgba(247,249,252,.85);
  display:flex; align-items:center;
  justify-content:center;
  z-index:9999;
}
.loader.hidden { display:none }
.spinner {
  width:52px; height:52px;
  border-radius:50%;
  border:4px solid #e0e6ff;
  border-top-color:#4f6cff;
  animation:spin .8s linear infinite;
}
@keyframes spin { to{transform:rotate(360deg)} }
</style>
</head>

<body>

<nav class="nav">
  <div class="nav-btn"><a href="/">Home</a></div>
  <div class="nav-btn"><a href="/">Menu</a></div>
  <div class="nav-btn"><a href="/faqs.html">FAQs</a></div>
</nav>

<div id="loader" class="loader hidden">
  <div class="spinner"></div>
</div>

<section class="container">
<h1>ðŸ“¦ Orders</h1>

<!-- STATS -->
<div class="stats">
  <div class="stat-card">
    <h3>Total Orders</h3>
    <p id="totalCount">0</p>
  </div>
  <div class="stat-card">
    <h3>Delivered Orders</h3>
    <p id="deliveredCount">0</p>
  </div>
  <div class="stat-card">
    <h3>Cancelled Orders</h3>
    <p id="cancelledCount">0</p>
  </div>
</div>

<!-- CHART -->
<div class="graphs">
  <canvas id="orderChart"></canvas>
</div>

<!-- DATE FILTER -->
<div class="control-card">
  <input type="date" id="fromDate">
  <input type="date" id="toDate">
  <button onclick="render()">Apply Date</button>
</div>

<!-- STATUS FILTER -->
<div class="control-card" id="statusButtons">
  <button class="active" onclick="setStatus('All', this)">All Orders</button>
  <button onclick="setStatus('Confirmed', this)">Confirmed</button>
  <button onclick="setStatus('Delivered', this)">Delivered</button>
  <button onclick="setStatus('Cancelled', this)">Cancelled</button>
</div>

<!-- ORDERS -->
<div id="orders" class="grid"></div>
</section>

<script>
const BASE="https://script.google.com/macros/s/AKfycbyfSn1mVLfdw22TA2jwmIVK01uidH7vjJKwYGcxm_yHDJA_0XA2bTf36UtSUdhhWsmLpA/exec"
const GET_API=BASE+"?type=orders"
const POST_API=BASE

const loader=document.getElementById("loader")
const ordersDiv=document.getElementById("orders")
let orders=[]
let chart
let currentStatus="All"

const show=()=>loader.classList.remove("hidden")
const hide=()=>loader.classList.add("hidden")

async function loadOrders(){
  show()
  const res=await fetch(GET_API)
  orders=await res.json()
  render()
  hide()
}

function setStatus(status, btn){
  currentStatus=status
  document.querySelectorAll("#statusButtons button").forEach(b=>b.classList.remove("active"))
  btn.classList.add("active")
  render()
}

function getFilteredOrders(chartOnly=false){
  const from=fromDate.value
  const to=toDate.value

  return orders.filter(o=>{
    const od=new Date(o["Order Date"]).toISOString().slice(0,10)
    if(!chartOnly && currentStatus!=="All" && o.Status!==currentStatus) return false
    if(from && od < from) return false
    if(to && od > to) return false
    return true
  })
}

function render(){
  const list = getFilteredOrders().sort(
    (a,b)=>new Date(b["Order Date"])-new Date(a["Order Date"])
  )

  totalCount.innerText=orders.length
  deliveredCount.innerText=orders.filter(o=>o.Status==="Delivered").length
  cancelledCount.innerText=orders.filter(o=>o.Status==="Cancelled").length

  ordersDiv.innerHTML=""

  list.forEach(o=>{
    let actions=""

    if(o.Status==="Confirmed"){
      actions=`
        <div class="actions">
          <button class="deliver" onclick="updateOrder(${o.id},'Delivered')">
            Deliver
          </button>
        </div>`
    }

    ordersDiv.innerHTML+=`
      <div class="card">
        <strong>${o["Customer Name"]}</strong>
        <p>${o["Food Item"]} Ã— ${o["Quantity Ordered"]}</p>
        <p>${o.Address}</p>
        <p>${formatWhatsAppNumber(o.Number)}</p>
        <p>Status: ${o.Status}</p>
        ${actions}
      </div>`
  })

  drawChart(getFilteredOrders(true))
}

function drawChart(data){
  if(chart) chart.destroy()

  const map={}
  data.forEach(o=>{
    const d=new Date(o["Order Date"]).toISOString().slice(0,10)
    map[d]=map[d]||{t:0,d:0,c:0}
    map[d].t++
    if(o.Status==="Delivered") map[d].d++
    if(o.Status==="Cancelled") map[d].c++
  })

  const labels=Object.keys(map).sort()

  chart=new Chart(orderChart,{
    type:"line",
    data:{
      labels,
      datasets:[
        { label:"Total", data:labels.map(l=>map[l].t), borderColor:"#4f6cff", tension:.4 },
        { label:"Delivered", data:labels.map(l=>map[l].d), borderColor:"#2dd4bf", tension:.4 },
        { label:"Cancelled", data:labels.map(l=>map[l].c), borderColor:"#f87171", tension:.4 }
      ]
    },
    options:{
      responsive:true,
      maintainAspectRatio:false,
      plugins:{ legend:{ position:"bottom" } }
    }
  })
}

async function updateOrder(id,status){
  show()
  const fd=new FormData()
  fd.append("action","orderStatus")
  fd.append("id",id)
  fd.append("status",status)
  await fetch(POST_API,{method:"POST",body:fd})
  await loadOrders()
}

function formatWhatsAppNumber(num){
  if(!num) return ""
  return "+" + num.replace(/@.*$/, "")
}

loadOrders()
</script>

</body>
</html>
